name: Release

on:
  release:
    types: [published]
  workflow_call:
    inputs:
      version:
        description: 'Version to release (e.g., v1.16.0)'
        required: true
        type: string

run-name: "Release ${{ inputs.version || github.event.release.tag_name }}"

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_call" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create release if called from workflow
        if: github.event_name == 'workflow_call'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --notes "Auto-generated release $VERSION" \
            --target main
      
      - name: Wait for release to be ready
        if: github.event_name == 'workflow_call'
        run: sleep 2
      
      - name: Get release info
        id: get_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          RELEASE_INFO=$(gh release view "$VERSION" --json id,tagName)
          TAG_NAME=$(echo "$RELEASE_INFO" | jq -r '.tagName')
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Update version file
        env:
          ACTOR: "${{ github.actor }}"
          EMAIL: "${{ github.actor }}@users.noreply.github.com"
          AUTHOR: "${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
          VERSION: "${{ steps.get_release.outputs.tag_name }}"
        run: |
          git config --global user.name "$ACTOR"
          git config --global user.email "$EMAIL"
          VERSION=$VERSION make version/SBX_VERSION

          git add version/SBX_VERSION
          git commit -m "Bump version to $VERSION" --author="$AUTHOR"

          git fetch origin main
          git merge FETCH_HEAD --no-edit
          git push origin main
      
      - uses: actions/setup-go@v5
      
      - name: Build binaries
        run: |
          mkdir -p dist
          GOOS=darwin GOARCH=amd64 go build -o dist/sbx-amd64 .
          GOOS=darwin GOARCH=arm64 go build -o dist/sbx-arm64 .
          tar -czvf dist/sbx-darwin-amd64.tar.gz -C dist sbx-amd64
          tar -czvf dist/sbx-darwin-arm64.tar.gz -C dist sbx-arm64
      
      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.get_release.outputs.tag_name }}
        run: |
          gh release upload "$VERSION" \
            dist/sbx-darwin-amd64.tar.gz \
            dist/sbx-darwin-arm64.tar.gz \
            --clobber
      
      - name: Release summary
        if: success()
        run: |
          VERSION="${{ steps.get_release.outputs.tag_name }}"
          echo "## ðŸš€ Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… sbx-darwin-amd64.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… sbx-darwin-arm64.tar.gz" >> $GITHUB_STEP_SUMMARY
